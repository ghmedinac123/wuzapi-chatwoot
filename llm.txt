# wuzapi-consumer - Contexto para LLMs

## Proyecto
WuzAPI â†” Chatwoot Integration
IntegraciÃ³n bidireccional WhatsApp-Chatwoot para Fututel (telecomunicaciones, 5000 clientes)
Python 3.12+ | FastAPI | Arquitectura Hexagonal | SOLID

## Arquitectura

### Capas (Hexagonal)
```
infrastructure/api/          â†’ Entrada HTTP (FastAPI webhooks)
application/use_cases/       â†’ OrquestaciÃ³n lÃ³gica negocio
domain/                      â†’ CORE (entities, value_objects, ports)
infrastructure/{adaptadores} â†’ Salida (chatwoot, wuzapi, persistence)
shared/                      â†’ Config y utilidades
```

### Flujo de Dependencias
```
api â†’ use_cases â†’ domain/ports â† implementan adaptadores
```

### Regla CRÃTICA
domain/ NUNCA importa de infrastructure/ o application/

## Principios

### SOLID
- S: WhatsAppMessage solo representa mensajes
- O: Extensible vÃ­a nuevos adaptadores sin modificar domain
- L: RedisCache/InMemoryCache intercambiables
- I: Interfaces pequeÃ±as (ChatwootRepository, WuzAPIRepository)
- D: UseCase depende de interfaces, no implementaciones

### Desarrollo
1. NUNCA modificar cÃ³digo que funciona
2. SIEMPRE extender, nunca reemplazar
3. Respetar capas (domain independiente)
4. Dependency Injection siempre
5. Type hints completos
6. Logging estructurado con emojis

## Estructura

```
src/
â”œâ”€ domain/
â”‚  â”œâ”€ entities/whatsapp_message.py     # Mensaje con identidad
â”‚  â”œâ”€ value_objects/phone_number.py    # TelÃ©fono inmutable
â”‚  â””â”€ ports/                           # Interfaces
â”‚     â”œâ”€ chatwoot_repository.py
â”‚     â”œâ”€ wuzapi_repository.py
â”‚     â””â”€ cache_repository.py
â”œâ”€ application/use_cases/
â”‚  â”œâ”€ sync_message_to_chatwoot.py      # WhatsApp â†’ Chatwoot
â”‚  â””â”€ send_message_to_whatsapp.py      # Chatwoot â†’ WhatsApp
â”œâ”€ infrastructure/
â”‚  â”œâ”€ api/webhook.py                   # POST /webhook/{wuzapi,chatwoot}
â”‚  â”œâ”€ chatwoot/client.py               # Implementa ChatwootRepository
â”‚  â”œâ”€ wuzapi/client.py                 # Implementa WuzAPIRepository
â”‚  â”œâ”€ persistence/
â”‚  â”‚  â”œâ”€ redis_cache.py                # Implementa CacheRepository
â”‚  â”‚  â””â”€ memory_cache.py               # Fallback
â”‚  â””â”€ logging/setup.py
â””â”€ shared/config.py                    # Pydantic Settings

main.py                                # Entry point
```

## Flujos

### WhatsApp â†’ Chatwoot
```
1. Cliente envÃ­a mensaje WhatsApp
2. WuzAPI webhook â†’ POST /webhook/wuzapi
3. Valida TOKEN
4. Parse â†’ WhatsAppMessage entity
5. SyncMessageToChatwootUseCase:
   a. create_or_get_contact()
   b. create_or_get_conversation()
   c. send_message()
6. Mensaje en Chatwoot Inbox
```

### Chatwoot â†’ WhatsApp
```
1. Agente responde en Chatwoot
2. Chatwoot webhook â†’ POST /webhook/chatwoot
3. SendMessageToWhatsAppUseCase:
   a. Valida message_type: outgoing
   b. Extrae telÃ©fono y contenido
   c. send_text_message() via WuzAPI
4. Cliente recibe en WhatsApp
```

## Datos

### WuzAPI Event (Nuevo Formato)
```json
{
  "type": "Message",
  "token": "CCE6198C6E2D-43A0-A4A9-598F53FE5C38",
  "event": {
    "Info": {
      "ID": "MSG_ID",
      "Chat": "573164973474@s.whatsapp.net",
      "IsFromMe": false,
      "Type": "text",
      "Timestamp": "2025-10-27T15:01:14-05:00"
    },
    "Message": {
      "extendedTextMessage": {
        "text": "Contenido del mensaje"
      }
    }
  }
}
```

### Chatwoot Event
```json
{
  "event": "message_created",
  "message": {
    "message_type": "outgoing",
    "content": "Respuesta del agente"
  },
  "conversation": {
    "inbox_id": 29,
    "contact_inbox": {
      "source_id": "573001234567"
    }
  }
}
```

## ConfiguraciÃ³n (.env)

```properties
# Servidor
PORT=8789
HOST=0.0.0.0
BACKEND_URL=integracion.wuzapi.torneofututel.com

# Chatwoot
CHATWOOT_URL=https://chatwoot.fututel.com
CHATWOOT_API_KEY=xxx
CHATWOOT_ACCOUNT_ID=2
CHATWOOT_INBOX_ID=29

# WuzAPI
WUZAPI_URL=https://wuzapi.torneofututel.com
WUZAPI_USER_TOKEN=xxx
WUZAPI_INSTANCE_TOKEN=CCE6198C6E2D-43A0-A4A9-598F53FE5C38

# Redis
REDIS_URL=redis://localhost:6379/0
```

## OperaciÃ³n

### Comandos
```bash
# Servicio
systemctl start wuzapi-chatwoot-integration
systemctl status wuzapi-chatwoot-integration
journalctl -u wuzapi-chatwoot-integration -f

# Health check
curl https://integracion.wuzapi.torneofututel.com/health

# Desarrollo
uv run python main.py
```

### Logs TÃ­picos
```
ðŸ“¥ EVENTO WUZAPI: Message | Token: CCE6198C...
âœ… Mensaje parseado: De +573001234567
ðŸ“¨ Sincronizando mensaje de 573001234567
âœ… Contacto creado: ID 123
âœ… ConversaciÃ³n creada: 456 (Inbox: 29)
âœ… Mensaje enviado a conversaciÃ³n 456
```

## Agregar Funcionalidad

### Template
```python
# PASO 1: Extender Port (interfaz)
# src/domain/ports/wuzapi_repository.py
class WuzAPIRepository(ABC):
    @abstractmethod
    async def send_NEW_TYPE_message(...) -> bool:
        pass

# PASO 2: Implementar en Adaptador
# src/infrastructure/wuzapi/client.py
class WuzAPIClient(WuzAPIRepository):
    async def send_NEW_TYPE_message(...) -> bool:
        # ImplementaciÃ³n
        pass

# PASO 3: Usar en UseCase (si aplica)
# src/application/use_cases/send_message_to_whatsapp.py
async def execute(self, event_data):
    # Detectar y usar nuevo tipo
    pass
```

### Ejemplo: Enviar ImÃ¡genes
```python
# Port
async def send_image_message(phone: str, image_url: str, caption: str) -> bool:
    pass

# Adaptador
async def send_image_message(phone, image_url, caption):
    data = {'phone': f"{phone}@s.whatsapp.net", 'image': image_url, 'caption': caption}
    response = await self.client.post('/message/image', json=data)
    return response.status_code in [200, 201]

# UseCase
attachments = message_data.get('attachments', [])
if attachments and attachments[0].get('file_type') == 'image':
    return await self.wuzapi_repo.send_image_message(phone, url, caption)
```

## Debugging

### Errores Comunes

**"Evento de instancia Unknown ignorado"**
- Causa: TOKEN no coincide
- Fix: Verificar WUZAPI_INSTANCE_TOKEN en .env

**"Could not parse message"**
- Causa: Formato de mensaje nuevo/no soportado
- Fix: Ver JSON completo en logs, agregar caso en WhatsAppMessage.from_wuzapi_event()

**"Redis no disponible"**
- No crÃ­tico: usa cachÃ© en memoria automÃ¡ticamente
- Fix (opcional): systemctl start redis

## Glosario

- **WuzAPI**: API WhatsApp Business multi-sesiÃ³n
- **Chatwoot**: Plataforma customer service
- **Inbox**: BuzÃ³n en Chatwoot (ej: Ventas ID=29)
- **Instance/Token**: SesiÃ³n WhatsApp en WuzAPI
- **JID**: WhatsApp ID (573001234567@s.whatsapp.net)
- **Conversation**: Hilo de mensajes
- **Entity**: Objeto con identidad (WhatsAppMessage)
- **Value Object**: Objeto inmutable (PhoneNumber)
- **Port**: Interfaz que define QUÃ‰ hacer
- **Adapter**: ImplementaciÃ³n que define CÃ“MO hacerlo
- **Use Case**: OrquestaciÃ³n de lÃ³gica de negocio

## FilosofÃ­a

**Regla de Oro**: Si funciona, NO se toca.

```
Antes de cambiar:
1. Â¿Funciona? â†’ NO cambiar
2. Â¿Nueva funcionalidad? â†’ AGREGAR, no modificar
3. Â¿Bug? â†’ Fix mÃ­nimo
4. Â¿Mejora arquitectura? â†’ Solo si no afecta existente
```

## Stack TÃ©cnico

- Python 3.12+
- FastAPI 0.104+
- httpx (HTTP async client)
- Pydantic 2.x (settings + validation)
- Redis 7+ (opcional)
- uv (package manager)
- Nginx + Let's Encrypt (producciÃ³n)
- Systemd (supervisor)

## Endpoints

```
GET  /              â†’ Info del servicio
GET  /health        â†’ Health check
POST /webhook/wuzapi    â†’ Recibe eventos WuzAPI
POST /webhook/chatwoot  â†’ Recibe eventos Chatwoot
```

## ProducciÃ³n

- **Dominio**: integracion.wuzapi.torneofututel.com
- **SSL**: Let's Encrypt (auto-renew)
- **Puerto**: 8789 (interno), 443 (pÃºblico HTTPS)
- **OS**: Ubuntu 24.04 LTS
- **Servidor**: VPS Proxmox

## Seguridad

### NUNCA en logs
- CHATWOOT_API_KEY
- WUZAPI_USER_TOKEN
- WUZAPI_INSTANCE_TOKEN

### OK en logs
- URLs pÃºblicas
- NÃºmeros de telÃ©fono (pÃºblicos en contexto)

### ValidaciÃ³n TOKEN
```python
if token != settings.WUZAPI_INSTANCE_TOKEN:
    logger.warning(f"Token invÃ¡lido: {token}")
    return  # Ignorar
```

## Testing

```bash
# Manual
1. Enviar mensaje WhatsApp
2. Ver logs: journalctl -u wuzapi-chatwoot-integration -f
3. Verificar llegada a Chatwoot
4. Responder en Chatwoot
5. Verificar llegada a WhatsApp

# Webhook test
curl -X POST https://integracion.wuzapi.torneofututel.com/webhook/wuzapi \
  -H "Content-Type: application/json" \
  -d '{"type":"Message","token":"TOKEN_AQUI"}'
```

## Referencias

- Hexagonal Architecture: Alistair Cockburn (2005)
- SOLID: Robert C. Martin
- DDD: Eric Evans

## Contacto

- Fututel ProgramaciÃ³n
- WhatsApp: +57 316 497 3474
- Email: soporte@fututel.com

---
VersiÃ³n: 2.0.0
Actualizado: 2025-10-27